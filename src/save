import java.io.File;
import java.io.FileNotFoundException;
import java.io.FileReader;
import java.io.IOException;
import java.io.Reader;
import java.io.StringReader;
import java.io.BufferedReader;

public class Principal {

    public static void generarLexer(String ruta){
        File lexerFile = new File("src/Lexer.java");
        lexerFile.delete();
        File archivo = new File(ruta);
        JFlex.Main.generate(archivo);
    }

    // Este método genera el archivo LexerCup.java
    public static void generarArchivoLexerCup(String ruta) throws IOException {
        // 1. Eliminar archivo anterior si existe
        File lexerCupFile = new File("src/LexerCup.java");
        if (lexerCupFile.exists()) {
            lexerCupFile.delete();
        }
        
        // 2. Generar nuevo LexerCup.java desde LexerCup.flex
        File archivo = new File(ruta);
        try {
            JFlex.Main.generate(archivo);
            System.out.println("✅ LexerCup.java generado exitosamente desde: " + ruta);
        } catch (Exception e) {
            System.out.println("❌ Error al generar LexerCup: " + e.getMessage());
            throw new IOException("Error generando LexerCup", e);
        }
    }
    
    // Este método analiza léxicamente (pero no funciona sin las variables Swing)
    // LO ELIMINO porque usa variables que no existen aquí
    /*
    public static void generarLexerCup() throws IOException{
        // Este método no funciona aquí porque txtResultado y txtAnalizarLex
        // son variables de la interfaz Swing (FrmPrincipal)
    }
    */

    public static void analizarArchivo(String rutaArchivo, boolean mostrarEnConsola) {
        try {
            Reader lector = new BufferedReader(new FileReader(rutaArchivo));
            Lexer lexer = new Lexer(lector);
            
            if (mostrarEnConsola) {
                System.out.println("\n=== ANÁLISIS LÉXICO ===");
                System.out.println("Archivo: " + rutaArchivo);
                System.out.println("========================\n");
            }
            
            StringBuilder resultado = new StringBuilder();
            int contadorTokens = 0;
            int contadorErrores = 0;
            
            while (true) {
                Tokens token = lexer.yylex();
                if (token == null) {
                    resultado.append("FIN DEL ANÁLISIS\n");
                    resultado.append("Total tokens válidos: ").append(contadorTokens).append("\n");
                    resultado.append("Total errores: ").append(contadorErrores).append("\n");
                    break;
                }
                
                String lineaResultado;
                switch (token) {
                    case ERROR:
                        contadorErrores++;
                        lineaResultado = "ERROR: Símbolo no definido -> '" + lexer.lexeme + "'\n";
                        break;
                    case Identificador:
                    case Numero:
                    default:
                        contadorTokens++;
                        lineaResultado = "Token: " + token;
                        if (lexer.lexeme != null && !lexer.lexeme.isEmpty()) {
                            lineaResultado += " -> '" + lexer.lexeme + "'";
                        }
                        lineaResultado += "\n";
                        break;
                }
                
                resultado.append(lineaResultado);
                
                if (mostrarEnConsola) {
                    System.out.print(lineaResultado);
                }
            }
            
            lector.close();
            
            // Si no se mostró en consola, imprimir resumen
            if (!mostrarEnConsola) {
                System.out.println("Análisis completado para: " + rutaArchivo);
                System.out.println("Tokens válidos: " + contadorTokens);
                System.out.println("Errores: " + contadorErrores);
            }
            
        } catch (FileNotFoundException ex) {
            System.err.println("ERROR: Archivo no encontrado - " + rutaArchivo);
        } catch (IOException ex) {
            System.err.println("ERROR de lectura: " + ex.getMessage());
        } catch (Exception ex) {
            System.err.println("ERROR inesperado: " + ex.getMessage());
            ex.printStackTrace();
        }
    }

    public static void analizadorLexico(String rutaArchivo) {
        analizarArchivo(rutaArchivo, true);
    }

    public static void main(String[] args) throws Exception {
        System.out.println("=== INICIANDO GENERACIÓN DE ARCHIVOS ===");
        
        String rutaLexer = "src/Lexer.flex";
        String rutaLexerCup = "src/LexerCup.flex";
        String[] rutaLexerCupStrings = {"-parser", "Sintax", "src/Sintax.cup"};
        
        System.out.println("1. Generando Lexer.java...");
        generarLexer(rutaLexer);
        
        System.out.println("2. Generando LexerCup.java...");
        generarArchivoLexerCup(rutaLexerCup);  // CAMBIÉ EL NOMBRE AQUÍ
        
        System.out.println("3. Generando Sintax.java desde CUP...");
        try {
            java_cup.Main.main(rutaLexerCupStrings);
            System.out.println("✅ Sintax.java generado exitosamente");
        } catch (Exception e) {
            System.out.println("❌ Error al generar Sintax.java: " + e.getMessage());
        }
        
        System.out.println("\n=== PROCESO COMPLETADO ===");
        System.out.println("Para compilar:");
        System.out.println("1. javac src/Tokens.java");
        System.out.println("2. javac src/Lexer.java");
        System.out.println("3. javac src/LexerCup.java");
        System.out.println("4. javac src/sym.java");
        System.out.println("5. javac src/Sintax.java");
        System.out.println("6. javac Principal.java");
        System.out.println("7. java Principal");
    }
}